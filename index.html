<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Scratch-Thon b1.0 (very beta)</title>
<script src="assets/jszip.js"></script>
<style>
:root { --bg: #0d1117; --sidebar: #161b22; --accent: #58a6ff; --text: #c9d1d9; --border: #30363d; --terminal: #010409; --red: #f85149; --green: #3fb950; }
body { margin:0; font-family:'Segoe UI',system-ui,sans-serif; background:var(--bg); color:var(--text); display:flex; height:100vh; flex-direction:column; overflow:hidden; }
#menu-bar { height:35px; background:var(--sidebar); display:flex; align-items:center; padding:0 15px; border-bottom:1px solid var(--border); font-size:12px; z-index:1000; }
.menu-btn { padding:4px 10px; cursor:pointer; border-radius:4px; position:relative; }
.menu-btn:hover { background:#21262d; }
.dropdown { display:none; position:absolute; top:100%; left:0; background:var(--sidebar); border:1px solid var(--border); min-width:160px; border-radius:4px; box-shadow:0 8px 16px rgba(0,0,0,0.5); }
.menu-btn:hover .dropdown { display:block; }
.dropdown div { padding:8px 15px; cursor:pointer; }
.dropdown div:hover { background:var(--accent); color:white; }
#palette { position:absolute; top:-100px; left:50%; transform:translateX(-50%); width:400px; background:var(--sidebar); border:1px solid var(--accent); border-radius:6px; padding:12px; transition:0.2s; z-index:2000; }
#palette.active { top:20px; }
#palette input { width:100%; background:var(--bg); border:1px solid var(--border); color:white; padding:8px; border-radius:4px; outline:none; }
#workspace { display:flex; flex-grow:1; overflow:hidden; }
#explorer { width:260px; background:var(--sidebar); border-right:1px solid var(--border); display:flex; flex-direction:column; }
.explorer-header { padding:12px; font-size:11px; font-weight:bold; color:#8b949e; text-transform:uppercase; border-bottom:1px solid var(--border); }
#file-list { flex-grow:1; overflow-y:auto; }
.item { padding:8px 15px; cursor:pointer; font-size:13px; display:flex; align-items:center; gap:10px; border-left:2px solid transparent; }
.item:hover { background:#21262d; }
.item.active { background:#1f2937; border-left-color:var(--accent); color:var(--accent); }
#editor-container { flex-grow:1; display:flex; background:var(--bg); position:relative; border-right:1px solid var(--border); }
#gutter { width:40px; background:var(--sidebar); color:#484f58; padding:20px 0; text-align:right; font-family:monospace; font-size:14px; line-height:1.6; user-select:none; border-right:1px solid var(--border); }
#gutter span { display:block; padding-right:8px; }
textarea { flex-grow:1; background:transparent; color:#d7dae0; border:none; padding:20px; font-family:'Consolas',monospace; font-size:14px; outline:none; resize:none; line-height:1.6; }
#output-pane { width:380px; background:#1c1c1c; display:flex; flex-direction:column; }
#stage-header { height:35px; background:var(--sidebar); display:flex; align-items:center; padding:0 10px; border-bottom:1px solid var(--border); gap:10px; }
.stage-btn { cursor:pointer; font-weight:bold; font-size:10px; padding:3px 8px; border-radius:3px; text-transform:uppercase; border:1px solid transparent; }
#run-btn { color:var(--green); border-color:var(--green); }
#stop-btn { color:var(--red); border-color:var(--red); }
#canvas { height:240px; background:white; margin:15px; border-radius:4px; position:relative; border:2px solid #333; overflow:hidden; }
#sprite { width:45px; position:absolute; top:90px; left:130px; transition:0.3s; }
#terminal { flex-grow:1; background:var(--terminal); padding:15px; font-family:monospace; font-size:12px; color:#3fb950; overflow-y:auto; border-top:1px solid var(--border); }
#ctx-menu { position:fixed; background:#21262d; border:1px solid var(--border); display:none; z-index:3000; border-radius:4px; min-width:140px; }
#ctx-menu div { padding:8px 15px; cursor:pointer; font-size:12px; }
#ctx-menu div:hover { background:var(--accent); }
#popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--sidebar); padding:20px; border-radius:6px; border:1px solid var(--border); display:none; z-index:4000; width:400px; max-height:80%; overflow:auto; }
#popup h3 { margin-top:0; color:var(--accent); }
#popup button { margin-top:10px; padding:4px 8px; background:var(--accent); border:none; color:white; cursor:pointer; border-radius:3px; }
</style>
</head>
<body>

<div id="palette">
  <div id="palette-label" style="font-size:10px; color:var(--accent); margin-bottom:5px;">COMMAND</div>
  <input type="text" id="palette-input" spellcheck="false">
</div>

<div id="menu-bar">
  <div style="font-weight:bold; color:var(--accent); margin-right:15px;">Scratch-Thon BETA</div>
  <div class="menu-btn">File
    <div class="dropdown">
      <div onclick="openPalette('NEW_SCRIPT')">New Script (.st)</div>
      <div onclick="document.getElementById('file-up').click()">Upload Image</div>
      <div onclick="exportToSB3()" style="color:#ffab19; font-weight:bold; border-top:1px solid var(--border)">Export .sb3 Project</div>
    </div>
  </div>
  <div class="menu-btn">Info
    <div class="dropdown">
      <div onclick="showPopup('update')">Update Log</div>
      <div onclick="showPopup('syntax')">Syntax Docs</div>
    </div>
  </div>
</div>

<div id="workspace">
  <div id="explorer">
    <div class="explorer-header">Explorer</div>
    <input type="file" id="file-up" hidden onchange="handleUp(this)">
    <div id="file-list"></div>
  </div>
  <div id="editor-container">
    <div id="gutter"></div>
    <textarea id="editor" spellcheck="false" oninput="sync()" onscroll="doScroll()"></textarea>
  </div>
  <div id="output-pane">
    <div id="stage-header">
      <div id="run-btn" class="stage-btn" onclick="runAll()">Run</div>
      <div id="stop-btn" class="stage-btn" onclick="stopAll()">Stop</div>
    </div>
    <div id="canvas"><img id="sprite" src=""></div>
    <div id="terminal">> Ultimate Engine Ready.</div>
  </div>
</div>

<div id="ctx-menu"></div>
<div id="popup"><h3></h3><div id="popup-content"></div><button onclick="closePopup()">Close</button></div>

<script>
let files = { "main.st":"onFlagclick()\ngotoXY(0,0)\nprint('Hello Scratch-Thon!')\nmove(100)\nwait(1)\nend()" };
let assets = {}; let active="main.st"; let linked=null; let isRunning=false;

// Gutter & Editor
const ed=document.getElementById('editor'), gt=document.getElementById('gutter');
function sync(){ if(active) files[active]=ed.value; gt.innerHTML=Array.from({length:ed.value.split('\n').length},(_,i)=>`<span>${i+1}</span>`).join(''); }
function doScroll(){ gt.scrollTop=ed.scrollTop; }

// Palette
function openPalette(cmd,t=""){ document.getElementById('palette-label').innerText=cmd; 
  const inp=document.getElementById('palette-input'); inp.value=cmd==='RENAME'?t:"script.st"; inp.focus(); inp.select();
  inp.onkeydown=(e)=>{ if(e.key==='Enter'){ const v=inp.value.trim(); if(!v.endsWith('.st')) return;
    if(cmd==='NEW_SCRIPT'){ files[v]="onFlagclick()\nend()"; active=v; }
    if(cmd==='RENAME'){ files[v]=files[t]; delete files[t]; if(active===t) active=v; }
    document.getElementById('palette').classList.remove('active'); render(); } };
}

// File Explorer
function render(){
  const l=document.getElementById('file-list'); l.innerHTML='';
  Object.keys(files).forEach(f=>{
    const d=document.createElement('div'); d.className=`item ${f===active?'active':''}`; d.innerHTML=`ðŸ“„ ${f}`;
    d.onclick=()=>{ active=f; ed.value=files[f]; sync(); render(); };
    d.oncontextmenu=(e)=>{ e.preventDefault(); const m=document.getElementById('ctx-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px';
      m.innerHTML=`<div onclick="openPalette('RENAME','${f}')">Rename</div><div onclick="delF('${f}')" style="color:red">Delete</div>`; };
    l.appendChild(d);
  });
  Object.keys(assets).forEach(a=>{
    const d=document.createElement('div'); d.className="item"; d.innerHTML=`ðŸ–¼ï¸ ${a}`;
    d.oncontextmenu=(e)=>{ e.preventDefault(); const m=document.getElementById('ctx-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px';
      m.innerHTML=`<div onclick="linkSprite('${a}')">Link to Sprite</div><div onclick="delA('${a}')" style="color:red">Delete</div>`; };
    l.appendChild(d);
  });
  ed.value=files[active]||""; sync();
}
function delF(n){ if(Object.keys(files).length>1){ delete files[n]; active=Object.keys(files)[0]; render(); } }
function delA(n){ delete assets[n]; render(); }
function linkSprite(n){ linked=n; const s=document.getElementById('sprite'); s.src=URL.createObjectURL(new Blob([assets[n].data])); }

window.onclick=()=>document.getElementById('ctx-menu').style.display='none';
async function handleUp(i){ const f=i.files[0]; if(!f) return; const buf=await f.arrayBuffer(); const hash=Array.from(new Uint8Array(await crypto.subtle.digest('SHA-1',buf))).map(b=>b.toString(16).padStart(2,'0')).join('').substring(0,32);
  assets[f.name]={data:buf,ext:f.name.split('.').pop(),hash}; render(); }

// Run All
async function runAll(){ isRunning=true; const t=document.getElementById('terminal'); t.innerHTML="> Executing All Scripts...\n"; const s=document.getElementById('sprite'); let x=130;
  for(const f of Object.keys(files)){ const lines=files[f].split('\n');
    for(const l of lines){ if(!isRunning) break;
      const m=l.trim().match(/(\w+)\((.*)\)/); if(!m) continue; const [_,cmd,args]=m; const v=args.replace(/['"]/g,'');
      if(cmd==="move"){ x+=parseInt(v); s.style.left=x+'px'; }
      if(cmd==="wait"){ await new Promise(r=>setTimeout(r,v*1000)); }
      if(cmd==="print"){ t.innerHTML+=`[${f}] ${v}\n`; }
    }
  } isRunning=false;
}
function stopAll(){ isRunning=false; }

// Popup
function showPopup(type){ const h=document.querySelector('#popup h3'), c=document.getElementById('popup-content'); h.innerText=type==='update'?'Update Log':'Syntax Docs'; c.innerHTML=type==='update'?`<ul>
<li>first beta release!</li>
</ul>`:`<ul>
<li>Use onFlagclick() to trigger script start</li>
<li>move(x), wait(x), print(msg), gotoXY(x,y)</li>
<li>Variables: setVar(name,value), changeVar(name,value)</li>
<li>Lists: addList(name), appendList(name,value)</li>
<li>Full Scratch blocks supported (motion, looks, control, sensing, operators)</li>
</ul>`;
document.getElementById('popup').style.display='block'; }
function closePopup(){ document.getElementById('popup').style.display='none'; }

// Export SB3
async function exportToSB3(){
  const t=document.getElementById('terminal'); t.innerHTML+="> Compiling SB3...\n";
  try{
    if(typeof JSZip==='undefined') throw new Error("JSZip not loaded");
    const zip=new JSZip();
    // Stage
    const stageId='cd21514d0531fdffb22204e0ec5ed84a'; 
    zip.file(stageId+'.svg',Uint8Array.from(atob("PHN2ZyB3aWR0aD0iNDgwIiBoZWlnaHQ9IjM2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg=="),c=>c.charCodeAt(0)));
    
    // Sprite
    let spriteId='b7853f557e4c6d1558509503460670d9', spriteExt='svg';
    if(linked){ const a=assets[linked]; spriteId=a.hash; spriteExt=a.ext; zip.file(spriteId+'.'+spriteExt,a.data); }
    else zip.file(spriteId+'.svg',Uint8Array.from(atob("PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMTgiIGZpbGw9IiNGRkFCMTkiLz48L3N2Zz4="),c=>c.charCodeAt(0)));
    
    const project={targets:[
      {isStage:true,objName:"Stage",name:"Stage",variables:{},lists:{},broadcasts:{},blocks:{},currentCostume:0,costumes:[{assetId:stageId,name:"bg",md5ext:stageId+".svg",dataFormat:"svg"}],sounds:[],layerOrder:0},
      {isStage:false,objName:"Sprite1",name:"Sprite1",variables:{},lists:{},broadcasts:{},blocks:{},currentCostume:0,costumes:[{assetId:spriteId,name:"c1",md5ext:spriteId+'.'+spriteExt,dataFormat:spriteExt}],sounds:[],x:0,y:0,layerOrder:1}
    ],meta:{semver:"3.0.0",vm:"0.2.0",agent:"Scratch-Thon Beta"}};
    
    // Compile all files into blocks
    const bks=project.targets[1].blocks;
    let last=null; let blkCounter=0;
    for(const fname of Object.keys(files)){
      const lines=files[fname].split('\n');
      for(const l of lines){
        const m=l.trim().match(/(\w+)\((.*)\)/); if(!m) continue; const [_,cmd,args]=m; const raw=args.split(',').map(x=>x.replace(/['"]/g,'').trim());
        const id='blk_'+blkCounter++; let b={opcode:"",next:null,parent:last,inputs:{},fields:{},shadow:false,topLevel:false};
        
        if(cmd==='onFlagclick'){ b.opcode='event_whenflagclicked'; b.topLevel=true; b.x=100; b.y=100; }
        else if(cmd==='move'){ b.opcode='motion_movesteps'; b.inputs.STEPS=[1,[4,parseFloat(raw[0])] ]; }
        else if(cmd==='print'){ b.opcode='looks_say'; b.inputs.MESSAGE=[1,[10,raw[0]]]; }
        else if(cmd==='wait'){ b.opcode='control_wait'; b.inputs.DURATION=[1,[5,parseFloat(raw[0])] ]; }
        else if(cmd==='gotoXY'){ b.opcode='motion_gotoxy'; b.inputs.X=[1,[4,parseFloat(raw[0])]]; b.inputs.Y=[1,[4,parseFloat(raw[1])] ]; }
        else continue;
        if(last) bks[last].next=id;
        bks[id]=b; last=id;
      }
    }
    
    zip.file('project.json',JSON.stringify(project,null,2));
    const content=await zip.generateAsync({type:"blob"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(content); a.download="project.sb3"; a.click();
    t.innerHTML+="> SB3 Export Complete.\n";
  }catch(e){ t.innerHTML+="> Error: "+e+"\n"; }
}

// Init
render(); ed.value=files[active]; sync();
</script>
</body>
</html>
